CREATE MATERIALIZED VIEW resumo_acidente_final_do_final_final_2
BUILD IMMEDIATE
REFRESH FORCE
ON DEMAND
AS SELECT
    TRIM(BR.br_cod) AS BR_Codigo,
    COUNT(*) AS Total_Acidentes,
    COUNT(CASE WHEN ho.HOCR_MORTOS > 0 THEN 1 END) AS Acidentes_Com_Mortos,
    COUNT(CASE WHEN ho.HOCR_FERIDOS_GRAVES > 0 THEN 1 END) AS Acidentes_Com_Feridos_Graves,
    COUNT(CASE WHEN ho.HOCR_FERIDOS_LEVES > 0 THEN 1 END) AS Acidentes_Com_Feridos_Leves,
    MAX(TO_CHAR(ho.HOCR_HORARIO, 'HH24:MI')) AS Horario_Pico_Acidentes,
    MAX(ho.HOCR_DIA_SEMANA) AS Dia_Semana_Mais_Acidentes,
    MAX(hl.HLOC_km) AS Localidade_Com_Mais_Acidentes,
    COUNT(DISTINCT ho.HOCR_UOP_ID) AS Unidades_Operacionais_Envolvidas,
    (SELECT OCR_TOTAL_ENVOLVIDOS FROM OCORRENCIA GROUP BY OCR_TOTAL_ENVOLVIDOS ORDER BY COUNT(OCR_TOTAL_ENVOLVIDOS) DESC FETCH FIRST 1 ROW ONLY) + 0 AS Moda_envolvidos,
    (SELECT OCR_MORTOS FROM OCORRENCIA GROUP BY OCR_MORTOS ORDER BY COUNT(OCR_MORTOS) DESC FETCH FIRST 1 ROW ONLY) + 0 AS Moda_mortos,
    (SELECT OCR_TOTAL_FERIDOS FROM OCORRENCIA GROUP BY OCR_TOTAL_FERIDOS ORDER BY COUNT(OCR_TOTAL_FERIDOS) DESC FETCH FIRST 1 ROW ONLY) + 0 AS Moda_feridos,
    (SELECT OCR_VEICULOS AS Moda_Veiculos_Envolvidos
FROM OCORRENCIA o
          JOIN LOCALIDADES l ON o.OCR_LOC_ID = l.LOC_ID
          JOIN BR ON l.LOC_BR_ID = BR.BR_ID
WHERE BR.BR_COD = TRIM(BR.br_cod)
GROUP BY OCR_VEICULOS
ORDER BY COUNT(*) DESC
FETCH FIRST 1 ROW ONLY) || ' ' AS Moda_Veiculos_Envolvidos,
    ROUND((COUNT(CASE WHEN ho.HOCR_DIA BETWEEN TO_DATE('2018-01-01', 'YYYY-MM-DD') AND TO_DATE('2018-12-31', 'YYYY-MM-DD') THEN 1 END) / COUNT(*)) * 100, 2) AS Percentual_Acidentes_2018,
    ROUND((COUNT(CASE WHEN ho.HOCR_DIA BETWEEN TO_DATE('2021-01-01', 'YYYY-MM-DD') AND TO_DATE('2021-12-31', 'YYYY-MM-DD') THEN 1 END) / COUNT(*)) * 100, 2) AS Percentual_Acidentes_2021,
    ROUND((COUNT(CASE WHEN o.OCR_DIA BETWEEN TO_DATE('2022-01-01', 'YYYY-MM-DD') AND TO_DATE('2022-12-31', 'YYYY-MM-DD') THEN 1 END) / COUNT(*)) * 100, 2) AS Percentual_Acidentes_2022,
    MAX(huop.HUOP_cod) AS UOP_Mais_Frequente_Codigo,
    MAX(CASE WHEN TO_CHAR(ho.HOCR_DIA, 'YYYY') = '2018' THEN TO_CHAR(ho.HOCR_DIA, 'Month') END) AS Mes_Mais_Frequente_2018,
    MAX(CASE WHEN TO_CHAR(ho.HOCR_DIA, 'YYYY') = '2021' THEN TO_CHAR(ho.HOCR_DIA, 'Month') END) AS Mes_Mais_Frequente_2021,
    MAX(CASE WHEN TO_CHAR(o.OCR_DIA, 'YYYY') = '2022' THEN TO_CHAR(o.OCR_DIA, 'Month') END) AS Mes_Mais_Frequente_2022,
    (SELECT CLM_NOME || ' - ' cnt FROM (SELECT
        COUNT(*) + 0 AS cnt
    FROM
        BR
        JOIN LOCALIDADES ON LOC_BR_ID = BR_ID
        JOIN OCORRENCIA ON OCR_LOC_ID = LOC_ID
        JOIN CLIMA tc ON OCR_CLM_ID = CLM_ID)) || ' ' AS CLIMA_BR,

COUNT(CASE WHEN COALESCE(o.OCR_TOTAL_FERIDOS, 0) > 0 OR COALESCE(ho.HOCR_TOTAL_FERIDOS, 0) > 0 THEN 1 END) AS Acidentes_Com_Vitimas_Feridas,
    COUNT(CASE WHEN COALESCE(o.OCR_ILESOS, 0) > 0 OR COALESCE(ho.HOCR_ILESOS, 0) > 0 THEN 1 END) AS Acidentes_Sem_Vitimas,
    COUNT(CASE WHEN COALESCE(o.OCR_MORTOS, 0) > 0 OR COALESCE(ho.HOCR_MORTOS, 0) > 0 THEN 1 END) AS Acidentes_Com_Vitimas_Fatais,

(SELECT
    CASE
        WHEN TO_CHAR(O.OCR_HORARIO, 'HH24:MI:SS') BETWEEN '00:00:00' AND '05:59:59' THEN 'Madrugada'
        WHEN TO_CHAR(O.OCR_HORARIO, 'HH24:MI:SS') BETWEEN '06:00:00' AND '11:59:59' THEN 'Manhã'
        WHEN TO_CHAR(O.OCR_HORARIO, 'HH24:MI:SS') BETWEEN '12:00:00' AND '17:59:59' THEN 'Tarde'
        ELSE 'Noite'
    END AS Horario_comum
FROM
    OCORRENCIA O
JOIN
    LOCALIDADES L ON O.OCR_LOC_ID = L.LOC_ID
JOIN
    BR ON L.LOC_BR_ID = BR.BR_ID
WHERE
    BR.BR_COD = TRIM(BR.br_cod) -- Substitua BR.br_cod pela variável ou valor desejado
GROUP BY
    TO_CHAR(O.OCR_HORARIO, 'HH24:MI:SS') -- Adicionando GROUP BY
ORDER BY
    COUNT(*) DESC
FETCH FIRST 1 ROW ONLY)|| ' ' AS Horario_comum
FROM
    BR
    --atual
    LEFT JOIN LOCALIDADES l ON l.LOC_br_id = BR.br_id
    LEFT JOIN OCORRENCIA o ON o.OCR_loc_id = l.LOC_id
    LEFT JOIN TIPO_ACIDENTE ta ON ta.TIP_id = o.OCR_TIP_ID
    LEFT JOIN UNIDADE_OPERACIONAL uop ON uop.UOP_id = o.OCR_UOP_ID
    LEFT JOIN DELEGACIA dlg ON dlg.DLG_id = uop.UOP_dlg_id
    LEFT JOIN CLIMA clm ON o.OCR_CLM_ID = clm.CLM_ID
    --historico
    LEFT JOIN HLOCALIDADES hl ON hl.HLOC_br_id = BR.br_id
    LEFT JOIN HOCORRENCIA ho ON ho.HOCR_loc_id = hl.HLOC_id
    LEFT JOIN HTIPO_ACIDENTE hta ON hta.HTIP_id = ho.HOCR_TIP_ID
    LEFT JOIN HUNIDADE_OPERACIONAL huop ON huop.HUOP_id = ho.HOCR_UOP_ID
    LEFT JOIN HDELEGACIA hdlg ON hdlg.HDLG_id = huop.HUOP_dlg_id
    LEFT JOIN HCLIMA hclm ON ho.HOCR_CLM_ID = hclm.HCLM_ID
    LEFT JOIN HSENTIDO_VIA hstv ON ho.HOCR_STV_ID = hstv.HSTV_ID
    LEFT JOIN HCLASSIFICACAO_ACIDENTE hcla ON ho.HOCR_CLA_ID = hcla.HCLA_ID
GROUP BY
    TRIM(BR.br_cod),
    CLM_NOME,
    TO_CHAR(ho.HOCR_HORARIO, 'MM'),
    TO_CHAR(ho.HOCR_HORARIO, 'YYYY');
